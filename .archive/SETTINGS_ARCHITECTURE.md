# Settings & Execution Mode Architecture Diagram

## System Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Ralph Ultra v3.0                           â”‚
â”‚                    Settings & Execution System                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          STORAGE LAYER                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                    â”‚
â”‚  ~/.config/ralph-ultra/                                          â”‚
â”‚  â”œâ”€â”€ settings.json          Global settings (JSON)               â”‚
â”‚  â”œâ”€â”€ principles.md          Custom coding principles             â”‚
â”‚  â””â”€â”€ .first-launch          First launch marker                  â”‚
â”‚                                                                    â”‚
â”‚  <project>/                                                       â”‚
â”‚  â”œâ”€â”€ prd.json              Project manifest + CLI overrides      â”‚
â”‚  â”œâ”€â”€ progress.txt          Execution progress tracking           â”‚
â”‚  â”œâ”€â”€ logs/                 Execution logs                        â”‚
â”‚  â””â”€â”€ .ralph-backups/       PRD backup history                    â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–²
         â”‚
         â”‚ loadSettings() / saveSettings()
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       CONFIG MANAGEMENT LAYER                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                    â”‚
â”‚  config.ts (Settings API)                                        â”‚
â”‚  â”œâ”€â”€ ensureConfigDir()      Create ~/.config/ralph-ultra/       â”‚
â”‚  â”œâ”€â”€ loadSettings()         Read settings.json                  â”‚
â”‚  â”œâ”€â”€ saveSettings()         Write settings.json                 â”‚
â”‚  â”œâ”€â”€ addToRecentProjects()  Update recent projects list        â”‚
â”‚  â”œâ”€â”€ loadPrinciples()       Load custom principles             â”‚
â”‚  â””â”€â”€ ensurePrinciplesFile() Initialize principles.md           â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–²
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚            â”‚          â”‚             â”‚          â”‚
    â–¼            â–¼          â–¼             â–¼          â–¼
    
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ralph   â”‚ â”‚Settings â”‚ â”‚Execute â”‚ â”‚Execution â”‚ â”‚ Cost     â”‚
â”‚Service  â”‚ â”‚ Panel   â”‚ â”‚Plan    â”‚ â”‚Planner   â”‚ â”‚ Tracker  â”‚
â”‚ (CLI    â”‚ â”‚(UI)    â”‚ â”‚View    â”‚ â”‚(Core)   â”‚ â”‚          â”‚
â”‚ Detect) â”‚ â”‚        â”‚ â”‚        â”‚ â”‚         â”‚ â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Settings Data Structure

```
Settings (JSON)
â”‚
â”œâ”€â”€ theme: string
â”‚   â””â”€â”€ Maps to: /src/themes/*.ts (dracula, nord, gruvbox, etc.)
â”‚
â”œâ”€â”€ notificationSound: boolean
â”‚   â””â”€â”€ Used by: NotificationToast component
â”‚
â”œâ”€â”€ debugMode: boolean
â”‚   â””â”€â”€ Used by: RalphService logging
â”‚
â”œâ”€â”€ preferredCli: string
â”‚   â””â”€â”€ Options: 'claude' | 'opencode' | 'codex' | 'gemini' | 'aider' | 'cody'
â”‚   â””â”€â”€ Used by: RalphService.detectAICLI()
â”‚
â”œâ”€â”€ cliFallbackOrder: string[]
â”‚   â””â”€â”€ Example: ['opencode', 'codex', 'gemini']
â”‚   â””â”€â”€ Used by: RalphService.tryFallbackChain()
â”‚
â”œâ”€â”€ recentProjects: RecentProject[]
â”‚   â”‚
â”‚   â”œâ”€â”€ path: string              (absolute path to project)
â”‚   â”œâ”€â”€ name: string              (display name)
â”‚   â”œâ”€â”€ color?: string            (hex color for UI)
â”‚   â”œâ”€â”€ icon?: string             (emoji or icon)
â”‚   â””â”€â”€ lastAccessed: string      (ISO timestamp)
â”‚
â”œâ”€â”€ openProjects?: SavedProject[]
â”‚   â”‚
â”‚   â”œâ”€â”€ path: string
â”‚   â”œâ”€â”€ name: string
â”‚   â””â”€â”€ color: string
â”‚
â””â”€â”€ activeProjectPath?: string
    â””â”€â”€ Currently unused
```

---

## Execution Mode System

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     EXECUTION MODE TYPES                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Type: 'balanced' | 'super-saver' | 'fast-delivery'           â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ balanced (default)                                      â”‚  â”‚
â”‚  â”‚ â€¢ Optimal cost-quality tradeoff                         â”‚  â”‚
â”‚  â”‚ â€¢ Primary: Claude Sonnet                                â”‚  â”‚
â”‚  â”‚ â€¢ Use: Most production workflows                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ super-saver                                             â”‚  â”‚
â”‚  â”‚ â€¢ Minimize costs                                        â”‚  â”‚
â”‚  â”‚ â€¢ Primary: Haiku, GPT-4o-mini, Gemini Flash           â”‚  â”‚
â”‚  â”‚ â€¢ Use: Cost-sensitive projects                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ fast-delivery                                           â”‚  â”‚
â”‚  â”‚ â€¢ Maximize speed and quality                            â”‚  â”‚
â”‚  â”‚ â€¢ Primary: Claude Opus, GPT-4o                         â”‚  â”‚
â”‚  â”‚ â€¢ Use: Time-critical or complex tasks                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Model Selection Flow (Mode-Based)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               getRecommendedModel(taskType, mode)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚  Input: taskType (13 types), mode (3 modes)                   â”‚
â”‚  Output: { modelId, provider, reason }                        â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                  â”‚                  â”‚
        â–¼                  â–¼                  â–¼
    
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  balanced    â”‚ â”‚ super-saver  â”‚ â”‚fast-delivery â”‚
    â”‚  (default)   â”‚ â”‚              â”‚ â”‚              â”‚
    â”‚              â”‚ â”‚              â”‚ â”‚              â”‚
    â”‚ Task â†’ Model â”‚ â”‚ Task â†’ Model â”‚ â”‚ Task â†’ Model â”‚
    â”‚ Mapping      â”‚ â”‚ Mapping      â”‚ â”‚ Mapping      â”‚
    â”‚              â”‚ â”‚              â”‚ â”‚              â”‚
    â”‚ 13 mappings  â”‚ â”‚ 13 mappings  â”‚ â”‚ 13 mappings  â”‚
    â”‚ per type     â”‚ â”‚ per type     â”‚ â”‚ per type     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                  â”‚                  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Select Primary or Fallback Model    â”‚
    â”‚  based on Quota Availability         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Return Recommended Model            â”‚
    â”‚  with Explanation Reason             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Task Types to Model Mapping

### Example: Task Type = "backend-api"

```
TASK_MODEL_MAPPING (balanced):
  backend-api â†’ {
    primary: { modelId: 'claude-sonnet-4-20250514', provider: 'anthropic' },
    fallback: { modelId: 'gpt-4o', provider: 'openai' }
  }

SUPER_SAVER_MAPPING (cost-optimized):
  backend-api â†’ {
    primary: { modelId: 'claude-3-5-haiku-20241022', provider: 'anthropic' },
    fallback: { modelId: 'gpt-4o-mini', provider: 'openai' }
  }

FAST_DELIVERY_MAPPING (speed-optimized):
  backend-api â†’ {
    primary: { modelId: 'claude-sonnet-4-20250514', provider: 'anthropic' },
    fallback: { modelId: 'gpt-4o', provider: 'openai' }
  }

Cost Comparison:
  Claude Haiku:         ~$0.0024 per 1k tokens
  Claude Sonnet:        ~$0.015 per 1k tokens  (6.25x more expensive)
  GPT-4o-mini:          ~$0.015 per 1k tokens
  GPT-4o:               ~$0.03 per 1k tokens   (12.5x more expensive)
```

---

## Execution Plan Generation Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              generateExecutionPlan(prd, quotas, mode)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Input:                                                      â”‚
â”‚    â€¢ prd: Product Requirements Document                     â”‚
â”‚    â€¢ quotas: Current provider quotas (optional)             â”‚
â”‚    â€¢ mode: ExecutionMode ('balanced'|'super-saver'|...)     â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  For each UserStory in PRD:            â”‚
    â”‚  1. Detect task type                   â”‚
    â”‚  2. Get recommended model for mode     â”‚
    â”‚  3. Estimate tokens by complexity      â”‚
    â”‚  4. Calculate cost estimate            â”‚
    â”‚  5. Generate alternative options       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Create ExecutionPlan object:          â”‚
    â”‚  â€¢ stories[] (with allocations)        â”‚
    â”‚  â€¢ summary (totals & warnings)         â”‚
    â”‚  â€¢ comparisons (all 3 modes)           â”‚
    â”‚  â€¢ selectedMode (input mode)           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Return ExecutionPlan                  â”‚
    â”‚                                        â”‚
    â”‚  Users can review:                     â”‚
    â”‚  â€¢ Recommended models per story        â”‚
    â”‚  â€¢ Cost estimates per mode             â”‚
    â”‚  â€¢ Alternative options                 â”‚
    â”‚  â€¢ Duration estimates                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Component Integration

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ExecutionPlanView                        â”‚
â”‚                    (Main Display Component)                 â”‚
â”‚                                                             â”‚
â”‚  [Header: "Execution Plan: ProjectName"                    â”‚
â”‚           Mode: âš– Balanced | ğŸ’° Super Saver | âš¡ Fast]    â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Mode Comparison Section                              â”‚ â”‚
â”‚  â”‚  âš– Balanced: $4.50 â€¢ 2h 30m                          â”‚ â”‚
â”‚  â”‚  ğŸ’° Super Saver: $1.20 â€¢ 3h 45m                      â”‚ â”‚
â”‚  â”‚  âš¡ Fast Delivery: $12.00 â€¢ 1h 15m                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Summary Section                                       â”‚ â”‚
â”‚  â”‚  Stories: 5                                            â”‚ â”‚
â”‚  â”‚  Total Cost: $4.50 (Balanced mode)                    â”‚ â”‚
â”‚  â”‚  Duration: 2h 30m                                     â”‚ â”‚
â”‚  â”‚  Models Used: claude-sonnet, gpt-4o-mini             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Story List                                            â”‚ â”‚
â”‚  â”‚  â–¶ STORY-001: Create API endpoint                     â”‚ â”‚
â”‚  â”‚    Type: backend-api | Complexity: medium             â”‚ â”‚
â”‚  â”‚    Model: anthropic/claude-sonnet-4-20250514           â”‚ â”‚
â”‚  â”‚    Cost: $0.85 | Duration: 30m                        â”‚ â”‚
â”‚  â”‚    â†’ Primary model for task type                      â”‚ â”‚
â”‚  â”‚                                                        â”‚ â”‚
â”‚  â”‚  STORY-002: Setup CI/CD pipeline                      â”‚ â”‚
â”‚  â”‚    ...                                                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚
â”‚  [Footer: â†‘/â†“ navigate â€¢ m mode â€¢ r refresh]              â”‚
â”‚           Showing 1-5 of 5 stories                         â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                              â”‚
       â”‚ Press 'M'                    â”‚ Press 'r'
       â–¼                              â–¼
    Cycle Mode            Refresh Plan
    balanced â†’ super-saver    Regenerate with
               â†’ fast-delivery current mode
               â†’ balanced
```

---

## Settings Panel Layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                âš™ Settings (Modal Overlay)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚ Themes (1-9, 0, -, =):        Preferred CLI (c):      â”‚
â”‚ 1. Dracula âœ“                  â— Claude âœ“              â”‚
â”‚ 2. Nord                       â— OpenCode              â”‚
â”‚ 3. Gruvbox                    â—‹ Codex                 â”‚
â”‚ 4. Tokyo Night                â—‹ Gemini                â”‚
â”‚ 5. Catppuccin                 â—‹ Aider                 â”‚
â”‚ 6. Monokai                    â—‹ Cody                  â”‚
â”‚                                                         â”‚
â”‚ Sound (s):                    Fallback Chain:          â”‚
â”‚ â— ON                          1. OpenCode             â”‚
â”‚                               2. Codex                â”‚
â”‚ Preview:                      3. Gemini               â”‚
â”‚ â–  Accent                      (Auto-detect all)       â”‚
â”‚ â–  Secondary                                           â”‚
â”‚ â–  â–  â–  Status                                          â”‚
â”‚                                                         â”‚
â”‚ [Press 1-9, 0, -, = for theme â€¢ s for sound]          â”‚
â”‚ [c for CLI â€¢ q/ESC to close]                          â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## CLI Detection Priority

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          RalphService.detectAICLI() Flow               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  â”Œâ”€ Priority 1: PRD-specific override â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ if (prd?.cli && isValidCLI(prd.cli)) {         â”‚    â”‚
â”‚  â”‚   return prd.cli;                              â”‚    â”‚
â”‚  â”‚ }                                               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚         â–¼                                                â”‚
â”‚  â”Œâ”€ Priority 2: Global preference â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ const settings = loadSettings();               â”‚    â”‚
â”‚  â”‚ if (settings.preferredCli) {                   â”‚    â”‚
â”‚  â”‚   return settings.preferredCli;                â”‚    â”‚
â”‚  â”‚ }                                               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚         â–¼                                                â”‚
â”‚  â”Œâ”€ Priority 3: PRD fallback chain â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ if (prd?.cliFallbackOrder?.length > 0) {      â”‚    â”‚
â”‚  â”‚   for each cli in prd.cliFallbackOrder {       â”‚    â”‚
â”‚  â”‚     if (healthy && available) return cli;      â”‚    â”‚
â”‚  â”‚   }                                             â”‚    â”‚
â”‚  â”‚ }                                               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚         â–¼                                                â”‚
â”‚  â”Œâ”€ Priority 4: Global fallback chain â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ const fallback = settings.cliFallbackOrder;    â”‚    â”‚
â”‚  â”‚ if (fallback?.length > 0) {                    â”‚    â”‚
â”‚  â”‚   for each cli in fallback {                   â”‚    â”‚
â”‚  â”‚     if (healthy && available) return cli;      â”‚    â”‚
â”‚  â”‚   }                                             â”‚    â”‚
â”‚  â”‚ }                                               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚         â–¼                                                â”‚
â”‚  â”Œâ”€ Priority 5: Auto-detect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ for each cli in ['claude', 'opencode', ...] {  â”‚    â”‚
â”‚  â”‚   if (installed && healthy) return cli;        â”‚    â”‚
â”‚  â”‚ }                                               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚         â–¼                                                â”‚
â”‚  â”Œâ”€ Fallback: Error â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ throw new Error('No AI CLI found')             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Persistence & Lifecycle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Settings Lifecycle in App                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  APP START                                             â”‚
â”‚    â”‚                                                   â”‚
â”‚    â”œâ”€â–º loadSettings() from ~/.config/ralph-ultra/     â”‚
â”‚    â”‚   settings.json                                  â”‚
â”‚    â”‚                                                   â”‚
â”‚    â”œâ”€â–º Initialize themes, load recent projects        â”‚
â”‚    â”‚                                                   â”‚
â”‚    â””â”€â–º Render UI with saved settings                  â”‚
â”‚                                                         â”‚
â”‚  USER CHANGES THEME (Press '1')                        â”‚
â”‚    â”‚                                                   â”‚
â”‚    â”œâ”€â–º useTheme() hook updates state                  â”‚
â”‚    â”‚                                                   â”‚
â”‚    â”œâ”€â–º Save to settings.json immediately              â”‚
â”‚    â”‚   settings['theme'] = 'dracula'                  â”‚
â”‚    â”‚   saveSettings(settings)                         â”‚
â”‚    â”‚                                                   â”‚
â”‚    â””â”€â–º Re-render with new theme                       â”‚
â”‚                                                         â”‚
â”‚  USER SELECTS CLI (Press 'c')                          â”‚
â”‚    â”‚                                                   â”‚
â”‚    â”œâ”€â–º SettingsPanel cycles through CLIs             â”‚
â”‚    â”‚                                                   â”‚
â”‚    â”œâ”€â–º handleCliSelection(cliName)                    â”‚
â”‚    â”‚   â€¢ Load settings                                â”‚
â”‚    â”‚   â€¢ Update preferredCli                          â”‚
â”‚    â”‚   â€¢ saveSettings()                               â”‚
â”‚    â”‚                                                   â”‚
â”‚    â””â”€â–º Next RalphService.detectAICLI() uses new CLI  â”‚
â”‚                                                         â”‚
â”‚  USER OPENS PROJECT                                    â”‚
â”‚    â”‚                                                   â”‚
â”‚    â”œâ”€â–º addToRecentProjects(project)                  â”‚
â”‚    â”‚   â€¢ Load settings                                â”‚
â”‚    â”‚   â€¢ Add/update in recentProjects array          â”‚
â”‚    â”‚   â€¢ Limit to 10 items                            â”‚
â”‚    â”‚   â€¢ saveSettings()                               â”‚
â”‚    â”‚                                                   â”‚
â”‚    â””â”€â–º Next app start shows project in recent list   â”‚
â”‚                                                         â”‚
â”‚  USER CHANGES EXECUTION MODE (Press 'M')              â”‚
â”‚    â”‚                                                   â”‚
â”‚    â”œâ”€â–º ExecutionPlanView.cycleMode()                 â”‚
â”‚    â”‚   â€¢ Update currentMode state                     â”‚
â”‚    â”‚   â€¢ âš ï¸ NOT persisted to disk                     â”‚
â”‚    â”‚                                                   â”‚
â”‚    â”œâ”€â–º useExecutionPlan triggers regeneration         â”‚
â”‚    â”‚   â€¢ generateExecutionPlan(prd, quotas, mode)    â”‚
â”‚    â”‚                                                   â”‚
â”‚    â”œâ”€â–º Display new costs & timings                    â”‚
â”‚    â”‚                                                   â”‚
â”‚    â””â”€â–º ON APP RESTART â†’ mode resets to 'balanced'   â”‚
â”‚                                                         â”‚
â”‚  APP SHUTDOWN                                          â”‚
â”‚    â”‚                                                   â”‚
â”‚    â””â”€â–º Settings persisted to ~/.config/ralph-ultra/  â”‚
â”‚        settings.json (except mode)                    â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Quota & Learning System Integration

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ExecutionPlan includes Learning Data                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                        â”‚
â”‚  generateExecutionPlan() parameters:                  â”‚
â”‚  â”œâ”€â”€ prd: PRD                                         â”‚
â”‚  â”œâ”€â”€ quotas: ProviderQuota[] (optional)              â”‚
â”‚  â”œâ”€â”€ projectPath: string                             â”‚
â”‚  â”œâ”€â”€ learningData: ModelLearningDB (optional)        â”‚
â”‚  â””â”€â”€ mode: ExecutionMode â—„â”€â”€ AFFECTS MODEL CHOICE   â”‚
â”‚                                                        â”‚
â”‚  For each story, calculateConfidenceScore():         â”‚
â”‚  â”œâ”€â”€ If learningData exists:                         â”‚
â”‚  â”‚   â€¢ Look up model + taskType in learnings         â”‚
â”‚  â”‚   â€¢ Calculate confidence from:                     â”‚
â”‚  â”‚     - Overall score (0-100)                       â”‚
â”‚  â”‚     - Success rate (0-1)                          â”‚
â”‚  â”‚     - Number of runs (experience)                 â”‚
â”‚  â”‚   â€¢ Result: 0.5-1.0 confidence range             â”‚
â”‚  â””â”€â”€ Else: default 0.5 (low confidence)             â”‚
â”‚                                                        â”‚
â”‚  Learning Loop:                                       â”‚
â”‚  1. Execute story with recommended model             â”‚
â”‚  2. Record performance:                              â”‚
â”‚     â€¢ Model ID, provider, duration                   â”‚
â”‚     â€¢ Tokens used, cost                              â”‚
â”‚     â€¢ Success rate, retry count                      â”‚
â”‚  3. Update learnings database                        â”‚
â”‚  4. Next plan regeneration uses updated data         â”‚
â”‚                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Cost Tracking Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Cost Tracker Flow                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                        â”‚
â”‚  Story Execution Starts:                             â”‚
â”‚  â”œâ”€â”€ costTracker.startStory()                        â”‚
â”‚  â”‚   â€¢ storyId, modelId, provider                    â”‚
â”‚  â”‚   â€¢ estimatedCost, retryCount                     â”‚
â”‚  â”‚                                                    â”‚
â”‚  Story Execution Completes:                          â”‚
â”‚  â”œâ”€â”€ costTracker.endStory()                          â”‚
â”‚  â”‚   â€¢ actualCost                                    â”‚
â”‚  â”‚   â€¢ inputTokens, outputTokens                     â”‚
â”‚  â”‚   â€¢ success (true/false)                          â”‚
â”‚  â”‚                                                    â”‚
â”‚  Storage Integration:                                 â”‚
â”‚  â””â”€â”€ CostTracker records saved to:                   â”‚
â”‚      (Location varies - possibly in-memory or DB)   â”‚
â”‚                                                        â”‚
â”‚  Pricing Database (hardcoded):                       â”‚
â”‚  â”œâ”€â”€ Anthropic: input $3/1M, output $15/1M          â”‚
â”‚  â”œâ”€â”€ OpenAI: input $10/1M, output $30/1M            â”‚
â”‚  â”œâ”€â”€ OpenRouter: input $5/1M, output $15/1M         â”‚
â”‚  â”œâ”€â”€ Gemini: input $0.5/1M, output $1.5/1M          â”‚
â”‚  â””â”€â”€ Local: free                                     â”‚
â”‚                                                        â”‚
â”‚  Example Calculation (balanced mode):               â”‚
â”‚  â”œâ”€â”€ Story: backend-api (medium complexity)          â”‚
â”‚  â”œâ”€â”€ Model: claude-sonnet-4-20250514                â”‚
â”‚  â”œâ”€â”€ Estimated: 15k input + 6k output tokens        â”‚
â”‚  â”œâ”€â”€ Calculation:                                    â”‚
â”‚  â”‚   Input:  (15,000 / 1,000,000) * $3.00 = $0.045 â”‚
â”‚  â”‚   Output: (6,000 / 1,000,000) * $15.00 = $0.090 â”‚
â”‚  â”‚   Total: $0.135                                   â”‚
â”‚  â””â”€â”€ Plus alternative costs for other modes         â”‚
â”‚                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Hook State Management

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       useExecutionPlan Hook (React State)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                        â”‚
â”‚  const [plan, setPlan] = useState<ExecutionPlan>     â”‚
â”‚  const [loading, setLoading] = useState<boolean>    â”‚
â”‚  const [error, setError] = useState<string>         â”‚
â”‚  const [currentMode, setCurrentMode] =              â”‚
â”‚    useState<ExecutionMode>('balanced')              â”‚
â”‚                                                        â”‚
â”‚  State Transitions:                                   â”‚
â”‚                                                        â”‚
â”‚  1. Mount Component                                   â”‚
â”‚     â”œâ”€â”€ loading = true                               â”‚
â”‚     â”œâ”€â”€ loadPRD() â†’ extract from file               â”‚
â”‚     â”œâ”€â”€ generateExecutionPlan(prd, quotas, mode)   â”‚
â”‚     â”œâ”€â”€ setPlan(executionPlan)                       â”‚
â”‚     â””â”€â”€ loading = false                              â”‚
â”‚                                                        â”‚
â”‚  2. User Cycles Mode (Press 'M')                     â”‚
â”‚     â”œâ”€â”€ cycleMode() called                           â”‚
â”‚     â”œâ”€â”€ setCurrentMode(nextMode)                     â”‚
â”‚     â””â”€â”€ [currentMode dependency triggers useEffect]  â”‚
â”‚                                                        â”‚
â”‚  3. Mode Dependency Triggers                         â”‚
â”‚     â”œâ”€â”€ loading = true                               â”‚
â”‚     â”œâ”€â”€ generateExecutionPlan(..., currentMode)     â”‚
â”‚     â”œâ”€â”€ setPlan(newPlan)                             â”‚
â”‚     â””â”€â”€ loading = false â†’ Display updated plan      â”‚
â”‚                                                        â”‚
â”‚  Dependencies:                                        â”‚
â”‚  â””â”€â”€ useEffect(() => {                               â”‚
â”‚      generatePlan()                                  â”‚
â”‚    }, [projectPath, generatePlan])                   â”‚
â”‚                                                        â”‚
â”‚      âš ï¸ generatePlan includes currentMode:          â”‚
â”‚      const executionPlan =                           â”‚
â”‚        generateExecutionPlan(..., currentMode)      â”‚
â”‚                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Summary of Key Flows

### Flow 1: User Changes Theme
```
SettingsPanel
  â†’ setTheme('dracula')
    â†’ useTheme() hook
      â†’ loadSettings()
      â†’ settings['theme'] = 'dracula'
      â†’ saveSettings(settings)
      â†’ UI re-renders with new theme
      â†’ ~/.config/ralph-ultra/settings.json updated
```

### Flow 2: User Changes Execution Mode
```
ExecutionPlanView
  â†’ Press 'M'
    â†’ cycleMode()
      â†’ setMode(nextMode)
        â†’ useExecutionPlan setCurrentMode
          â†’ [currentMode] dependency
            â†’ generateExecutionPlan(..., mode)
              â†’ Select mode-specific mapping
              â†’ Calculate new costs & timings
              â†’ Update display
              âš ï¸ NOT saved to disk
              âš ï¸ Resets on app restart
```

### Flow 3: Story Execution
```
RalphService.run(projectPath)
  â†’ detectAICLI() [uses settings.preferredCli]
  â†’ loadOrGenerateExecutionPlan(prd)
    â†’ generateExecutionPlan(..., mode)
      â†’ Select models by mode
      â†’ Allocate story to model
  â†’ mapModelIdToCLIFlag(modelId)
  â†’ Execute story with selected model
  â†’ Extract tokens & calculate actual cost
  â†’ Record in LearningRecorder
  â†’ Next plan regeneration uses learning data
```

---

End of Architecture Documentation
