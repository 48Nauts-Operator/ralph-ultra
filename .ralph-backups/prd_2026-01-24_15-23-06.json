{
  "project": "ralph-ultra-phase3",
  "description": "Phase 3: Execute with Plan + Cost Tracking - Use execution plan during story execution, track actual costs vs estimates, record performance for learning",
  "branchName": "ralph/phase3-execute-with-plan",
  "userStories": [
    {
      "id": "US-001",
      "title": "Create cost tracker module",
      "description": "Create src/core/cost-tracker.ts that tracks actual token usage and costs during story execution. This is a tracer bullet - minimal end-to-end tracking first.",
      "acceptanceCriteria": [
        {
          "id": "AC-001-1",
          "text": "cost-tracker.ts file exists in src/core/",
          "testCommand": "test -f src/core/cost-tracker.ts",
          "passes": true,
          "lastRun": "2026-01-24T14:04:09.344Z"
        },
        {
          "id": "AC-001-2",
          "text": "CostTracker class exported with startStory, endStory, and getSessionCosts methods",
          "testCommand": "grep -q 'export.*class CostTracker' src/core/cost-tracker.ts && grep -q 'startStory' src/core/cost-tracker.ts && grep -q 'endStory' src/core/cost-tracker.ts && grep -q 'getSessionCosts' src/core/cost-tracker.ts",
          "passes": true,
          "lastRun": "2026-01-24T14:04:09.344Z"
        },
        {
          "id": "AC-001-3",
          "text": "StoryExecutionRecord interface defined with storyId, modelId, startTime, endTime, estimatedCost, actualCost, success, retryCount",
          "testCommand": "grep -q 'interface StoryExecutionRecord' src/core/cost-tracker.ts && grep -q 'estimatedCost' src/core/cost-tracker.ts && grep -q 'actualCost' src/core/cost-tracker.ts",
          "passes": true,
          "lastRun": "2026-01-24T14:04:09.344Z"
        },
        {
          "id": "AC-001-4",
          "text": "Costs are persisted to ~/.config/ralph-ultra/cost-history.json",
          "testCommand": "grep -q 'cost-history.json' src/core/cost-tracker.ts",
          "passes": true,
          "lastRun": "2026-01-24T14:04:09.344Z"
        }
      ],
      "complexity": "medium",
      "passes": true
    },
    {
      "id": "US-002",
      "title": "Integrate cost tracker into RalphService",
      "description": "Wire CostTracker into RalphService to record costs when stories start and end. Extract actual token usage from Claude CLI output when available.",
      "acceptanceCriteria": [
        {
          "id": "AC-002-1",
          "text": "RalphService imports and instantiates CostTracker",
          "testCommand": "grep -q 'CostTracker' src/utils/ralph-service.ts && grep -q 'cost-tracker' src/utils/ralph-service.ts",
          "passes": true,
          "lastRun": "2026-01-24T14:08:00.051Z"
        },
        {
          "id": "AC-002-2",
          "text": "startStory called when a story begins execution with estimated cost from plan",
          "testCommand": "grep -q 'startStory' src/utils/ralph-service.ts",
          "passes": true,
          "lastRun": "2026-01-24T14:08:00.051Z"
        },
        {
          "id": "AC-002-3",
          "text": "endStory called when story completes with success/failure status",
          "testCommand": "grep -q 'endStory' src/utils/ralph-service.ts",
          "passes": true,
          "lastRun": "2026-01-24T14:08:00.051Z"
        },
        {
          "id": "AC-002-4",
          "text": "Token extraction from output when Claude CLI provides usage stats (regex pattern for 'tokens used' or similar)",
          "testCommand": "grep -q 'token' src/utils/ralph-service.ts && grep -q 'extractToken\\|parseToken\\|usage' src/utils/ralph-service.ts",
          "passes": true,
          "lastRun": "2026-01-24T14:08:00.051Z"
        }
      ],
      "complexity": "medium",
      "passes": true
    },
    {
      "id": "US-003",
      "title": "Add model selection from execution plan",
      "description": "When Ralph runs a story, use the model recommended in the execution plan instead of hardcoded defaults. Pass model flag to Claude CLI.",
      "acceptanceCriteria": [
        {
          "id": "AC-003-1",
          "text": "RalphService loads or generates execution plan before running",
          "testCommand": "grep -q 'ExecutionPlan\\|executionPlan\\|generateExecutionPlan' src/utils/ralph-service.ts",
          "passes": true,
          "lastRun": "2026-01-24T14:11:12.269Z"
        },
        {
          "id": "AC-003-2",
          "text": "Model from plan is passed to CLI command (--model flag or equivalent)",
          "testCommand": "grep -q '\\-\\-model\\|recommendedModel' src/utils/ralph-service.ts",
          "passes": true,
          "lastRun": "2026-01-24T14:11:12.269Z"
        },
        {
          "id": "AC-003-3",
          "text": "Fallback to default model if plan unavailable or model not supported by CLI",
          "testCommand": "grep -q 'fallback\\|default.*model\\|DEFAULT_MODEL' src/utils/ralph-service.ts",
          "passes": true,
          "lastRun": "2026-01-24T14:11:12.269Z"
        }
      ],
      "complexity": "medium",
      "passes": true
    },
    {
      "id": "US-004",
      "title": "Create CostDashboard component",
      "description": "Create src/components/CostDashboard.tsx to display current session costs, historical costs, and estimated vs actual comparison.",
      "acceptanceCriteria": [
        {
          "id": "AC-004-1",
          "text": "CostDashboard.tsx file exists in src/components/",
          "testCommand": "test -f src/components/CostDashboard.tsx",
          "passes": true,
          "lastRun": "2026-01-24T14:13:42.628Z"
        },
        {
          "id": "AC-004-2",
          "text": "Displays current session: stories completed, total cost, time elapsed",
          "testCommand": "grep -q 'session\\|Session' src/components/CostDashboard.tsx && grep -q 'cost\\|Cost' src/components/CostDashboard.tsx",
          "passes": true,
          "lastRun": "2026-01-24T14:13:42.628Z"
        },
        {
          "id": "AC-004-3",
          "text": "Shows estimated vs actual cost comparison with variance indicator",
          "testCommand": "grep -q 'estimated\\|Estimated' src/components/CostDashboard.tsx && grep -q 'actual\\|Actual' src/components/CostDashboard.tsx",
          "passes": true,
          "lastRun": "2026-01-24T14:13:42.628Z"
        },
        {
          "id": "AC-004-4",
          "text": "Displays per-story breakdown with model used and cost",
          "testCommand": "grep -q 'story\\|Story' src/components/CostDashboard.tsx && grep -q 'model\\|Model' src/components/CostDashboard.tsx",
          "passes": true,
          "lastRun": "2026-01-24T14:13:42.628Z"
        }
      ],
      "complexity": "medium",
      "passes": true
    },
    {
      "id": "US-005",
      "title": "Add Cost view to WorkPane (key 8)",
      "description": "Wire CostDashboard as a new view in WorkPane accessible via key 8.",
      "acceptanceCriteria": [
        {
          "id": "AC-005-1",
          "text": "WorkPane imports CostDashboard component",
          "testCommand": "grep -q 'CostDashboard' src/components/WorkPane.tsx",
          "passes": true,
          "lastRun": "2026-01-24T14:16:20.510Z"
        },
        {
          "id": "AC-005-2",
          "text": "WorkPaneView type includes 'costs' as a valid view option",
          "testCommand": "grep -q \"'costs'\\|costs\" src/types/index.ts",
          "passes": true,
          "lastRun": "2026-01-24T14:16:20.510Z"
        },
        {
          "id": "AC-005-3",
          "text": "App.tsx handles key '8' to switch to costs view",
          "testCommand": "grep -q \"'8'\" src/components/App.tsx && grep -q 'costs' src/components/App.tsx",
          "passes": true,
          "lastRun": "2026-01-24T14:16:20.510Z"
        },
        {
          "id": "AC-005-4",
          "text": "ShortcutsBar shows key 8 for Costs view",
          "testCommand": "grep -q '8' src/components/ShortcutsBar.tsx",
          "passes": true,
          "lastRun": "2026-01-24T14:16:20.510Z"
        }
      ],
      "complexity": "simple",
      "passes": true
    },
    {
      "id": "US-006",
      "title": "Create useCostTracker hook",
      "description": "Create src/hooks/useCostTracker.tsx React hook that subscribes to cost updates and provides session cost data to components.",
      "acceptanceCriteria": [
        {
          "id": "AC-006-1",
          "text": "useCostTracker.tsx file exists in src/hooks/",
          "testCommand": "test -f src/hooks/useCostTracker.tsx",
          "passes": true,
          "lastRun": "2026-01-24T14:19:05.640Z"
        },
        {
          "id": "AC-006-2",
          "text": "Hook exports useCostTracker that returns sessionCosts, historicalCosts, isTracking",
          "testCommand": "grep -q 'export.*useCostTracker' src/hooks/useCostTracker.tsx && grep -q 'sessionCosts' src/hooks/useCostTracker.tsx",
          "passes": true,
          "lastRun": "2026-01-24T14:19:05.640Z"
        },
        {
          "id": "AC-006-3",
          "text": "Hook subscribes to cost-tracker events via event bus or direct subscription",
          "testCommand": "grep -q 'subscribe\\|useEffect\\|eventBus\\|EventBus' src/hooks/useCostTracker.tsx",
          "passes": true,
          "lastRun": "2026-01-24T14:19:05.640Z"
        }
      ],
      "complexity": "simple",
      "passes": true
    },
    {
      "id": "US-007",
      "title": "Create learning recorder module",
      "description": "Create src/core/learning-recorder.ts that records model performance data for future recommendations. Uses ModelPerformanceRecord and ModelLearningDB types from types.ts.",
      "acceptanceCriteria": [
        {
          "id": "AC-007-1",
          "text": "learning-recorder.ts file exists in src/core/",
          "testCommand": "test -f src/core/learning-recorder.ts",
          "passes": true,
          "lastRun": "2026-01-24T14:23:05.645Z"
        },
        {
          "id": "AC-007-2",
          "text": "LearningRecorder class exported with recordRun, getModelStats, and getBestModelForTask methods",
          "testCommand": "grep -q 'export.*class LearningRecorder\\|export.*LearningRecorder' src/core/learning-recorder.ts && grep -q 'recordRun' src/core/learning-recorder.ts && grep -q 'getModelStats\\|getBestModel' src/core/learning-recorder.ts",
          "passes": true,
          "lastRun": "2026-01-24T14:23:05.645Z"
        },
        {
          "id": "AC-007-3",
          "text": "Uses ModelPerformanceRecord type from core/types.ts",
          "testCommand": "grep -q 'ModelPerformanceRecord' src/core/learning-recorder.ts",
          "passes": true,
          "lastRun": "2026-01-24T14:23:05.645Z"
        },
        {
          "id": "AC-007-4",
          "text": "Learning data persisted to ~/.config/ralph-ultra/learning.json",
          "testCommand": "grep -q 'learning.json' src/core/learning-recorder.ts",
          "passes": true,
          "lastRun": "2026-01-24T14:23:05.645Z"
        },
        {
          "id": "AC-007-5",
          "text": "Calculates efficiency, speed, and reliability scores per model+taskType combination",
          "testCommand": "grep -q 'efficiencyScore\\|speedScore\\|reliabilityScore' src/core/learning-recorder.ts",
          "passes": true,
          "lastRun": "2026-01-24T14:23:05.645Z"
        }
      ],
      "complexity": "complex",
      "passes": true
    },
    {
      "id": "US-008",
      "title": "Integrate learning recorder with execution flow",
      "description": "Wire LearningRecorder into RalphService to automatically record performance after each story completes.",
      "acceptanceCriteria": [
        {
          "id": "AC-008-1",
          "text": "RalphService imports and instantiates LearningRecorder",
          "testCommand": "grep -q 'LearningRecorder' src/utils/ralph-service.ts && grep -q 'learning-recorder' src/utils/ralph-service.ts",
          "passes": false,
          "lastRun": null
        },
        {
          "id": "AC-008-2",
          "text": "recordRun called after each story completion with full performance data",
          "testCommand": "grep -q 'recordRun' src/utils/ralph-service.ts",
          "passes": false,
          "lastRun": null
        },
        {
          "id": "AC-008-3",
          "text": "Performance data includes: storyId, taskType, modelId, duration, tokens, cost, success, acPassRate",
          "testCommand": "grep -q 'taskType\\|acPassRate\\|duration' src/utils/ralph-service.ts",
          "passes": false,
          "lastRun": null
        }
      ],
      "complexity": "medium",
      "passes": false
    },
    {
      "id": "US-009",
      "title": "Update execution planner to use learning data",
      "description": "Enhance execution-planner.ts to consult learning data when recommending models, preferring models with proven track record for each task type.",
      "acceptanceCriteria": [
        {
          "id": "AC-009-1",
          "text": "execution-planner.ts imports LearningRecorder",
          "testCommand": "grep -q 'LearningRecorder\\|learning-recorder' src/core/execution-planner.ts",
          "passes": false,
          "lastRun": null
        },
        {
          "id": "AC-009-2",
          "text": "generateExecutionPlan optionally accepts learning data to influence recommendations",
          "testCommand": "grep -q 'learning\\|Learning' src/core/execution-planner.ts",
          "passes": false,
          "lastRun": null
        },
        {
          "id": "AC-009-3",
          "text": "Model confidence score reflects learning data when available (higher confidence for proven models)",
          "testCommand": "grep -q 'confidence' src/core/execution-planner.ts",
          "passes": false,
          "lastRun": null
        }
      ],
      "complexity": "medium",
      "passes": false
    },
    {
      "id": "US-010",
      "title": "Export Phase 3 modules from core index",
      "description": "Update src/core/index.ts to export all new Phase 3 modules (cost-tracker, learning-recorder).",
      "acceptanceCriteria": [
        {
          "id": "AC-010-1",
          "text": "core/index.ts exports from cost-tracker",
          "testCommand": "grep -q 'cost-tracker' src/core/index.ts",
          "passes": false,
          "lastRun": null
        },
        {
          "id": "AC-010-2",
          "text": "core/index.ts exports from learning-recorder",
          "testCommand": "grep -q 'learning-recorder' src/core/index.ts",
          "passes": false,
          "lastRun": null
        },
        {
          "id": "AC-010-3",
          "text": "TypeScript compiles without errors",
          "testCommand": "cd /Volumes/DevHub_ext/factory/toolbox/ralph-ultra && bun run typecheck",
          "passes": false,
          "lastRun": null
        }
      ],
      "complexity": "simple",
      "passes": false
    }
  ]
}