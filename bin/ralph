#!/bin/bash
# Ralph Ultra - Unified CLI
# Main entry point for all Ralph commands

set -e

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Output helpers
error() { echo -e "${RED}[ERROR]${NC} $1" >&2; exit 1; }
info() { echo -e "${BLUE}[INFO]${NC} $1"; }
success() { echo -e "${GREEN}[OK]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }

# Determine script directories
RALPH_BIN_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
RALPH_ROOT="$(dirname "$RALPH_BIN_DIR")"
RALPH_SCRIPTS_DIR="$RALPH_ROOT/scripts"
RALPH_VERSION_FILE="$RALPH_ROOT/VERSION"

# Ensure scripts directory exists
if [[ ! -d "$RALPH_SCRIPTS_DIR" ]]; then
  error "Scripts directory not found: $RALPH_SCRIPTS_DIR"
fi

# Read version
get_version() {
  if [[ -f "$RALPH_VERSION_FILE" ]]; then
    cat "$RALPH_VERSION_FILE" | tr -d '\n'
  else
    echo "unknown"
  fi
}

# Show version
show_version() {
  echo "ralph $(get_version)"
}

# Discover available commands from scripts directory
discover_commands() {
  local commands=()

  # Built-in commands (implemented in this file or as separate scripts)
  commands+=("run:Execute a Ralph project (wraps ralph.sh)")
  commands+=("status:Show Ralph status (quota, hybrid, timing)")
  commands+=("quota:Manage Claude Pro quota")
  commands+=("hybrid:Manage hybrid LLM routing")
  commands+=("stats:Show timing statistics")
  commands+=("init:Initialize a new Ralph project")

  printf '%s\n' "${commands[@]}"
}

# Show help
show_help() {
  cat << EOF
$(show_version)
Unified CLI for Ralph Ultra - Autonomous AI Agent System

USAGE:
  ralph <command> [options] [args]

COMMANDS:
  run       Execute a Ralph project (wraps ralph.sh)
  status    Show Ralph status (quota, hybrid, timing)
  quota     Manage Claude Pro quota
  hybrid    Manage hybrid LLM routing
  stats     Show timing statistics
  init      Initialize a new Ralph project

GLOBAL OPTIONS:
  --help, -h     Show this help
  --version, -v  Show version

Use 'ralph <command> --help' for command-specific help.

EXAMPLES:
  ralph run /path/to/project
  ralph status
  ralph quota --check
  ralph hybrid --status

For more information, visit: https://github.com/yourusername/ralph-ultra
EOF
}

# Show unified status
show_status() {
  local project_path="${1:-}"

  # Handle help flag
  if [[ "$project_path" == "--help" || "$project_path" == "-h" ]]; then
    cat << EOF
ralph status - Show Ralph system and project status

USAGE:
  ralph status                Show global status (quota, hybrid, timing)
  ralph status <project>      Show project-specific status

EXAMPLES:
  ralph status                # Global system status
  ralph status .              # Current project status
  ralph status /path/to/proj  # Specific project status

The global status shows:
  - Claude Pro quota usage and cooldowns
  - Hybrid LLM routing configuration and stats
  - Timing database statistics

The project status shows:
  - PRD progress (completed/remaining stories)
  - Monitor session status
  - Recent timing data
  - Event logs
EOF
    return 0
  fi

  # If project path provided, show project-specific status
  if [[ -n "$project_path" ]]; then
    show_project_status "$project_path"
    return
  fi

  # Otherwise show global status
  echo ""
  echo -e "${CYAN}╔══════════════════════════════════════════════════╗${NC}"
  echo -e "${CYAN}║              Ralph Ultra Status                  ║${NC}"
  echo -e "${CYAN}╚══════════════════════════════════════════════════╝${NC}"
  echo ""

  # 1. Quota Status
  echo -e "${BLUE}━━━ Quota Status ━━━${NC}"
  if [[ -f "$RALPH_SCRIPTS_DIR/ralph-quota.sh" ]]; then
    # Source the script to get functions
    (
      source "$RALPH_SCRIPTS_DIR/ralph-quota.sh"
      show_status 2>/dev/null || echo "  Quota check unavailable"
    )
  else
    warn "ralph-quota.sh not found"
  fi

  echo ""

  # 2. Hybrid LLM Status
  echo -e "${BLUE}━━━ Hybrid LLM Status ━━━${NC}"
  if [[ -f "$RALPH_SCRIPTS_DIR/ralph-hybrid.sh" ]]; then
    (
      source "$RALPH_SCRIPTS_DIR/ralph-hybrid.sh"
      show_status 2>/dev/null || echo "  Hybrid status unavailable"
    )
  else
    warn "ralph-hybrid.sh not found"
  fi

  echo ""

  # 3. Timing Database Status
  echo -e "${BLUE}━━━ Timing Database ━━━${NC}"
  if [[ -f "$RALPH_SCRIPTS_DIR/ralph-timing-db.sh" ]]; then
    (
      source "$RALPH_SCRIPTS_DIR/ralph-timing-db.sh"
      show_status 2>/dev/null || echo "  Timing stats unavailable"
    )
  else
    warn "ralph-timing-db.sh not found"
  fi

  echo ""
}

# Show project-specific status
show_project_status() {
  local project_path="$1"

  # Validate project directory
  if [[ ! -d "$project_path" ]]; then
    error "Project directory not found: $project_path"
  fi

  cd "$project_path" || error "Cannot access project directory: $project_path"

  echo ""
  echo -e "${CYAN}╔══════════════════════════════════════════════════╗${NC}"
  echo -e "${CYAN}║           Ralph Project Status                   ║${NC}"
  echo -e "${CYAN}╚══════════════════════════════════════════════════╝${NC}"
  echo ""

  info "Project: $(pwd)"
  echo ""

  # Check for PRD file
  if [[ -f "prd.json" ]]; then
    echo -e "${BLUE}━━━ PRD Status ━━━${NC}"

    if command -v jq &>/dev/null; then
      local project_name=$(jq -r '.project // "unknown"' prd.json 2>/dev/null)
      local branch_name=$(jq -r '.branchName // "unknown"' prd.json 2>/dev/null)
      local total_stories=$(jq '[.userStories[]] | length' prd.json 2>/dev/null)
      local completed=$(jq '[.userStories[] | select(.passes == true)] | length' prd.json 2>/dev/null)
      local remaining=$((total_stories - completed))

      echo "  Project:    $project_name"
      echo "  Branch:     $branch_name"
      echo "  Stories:    $completed/$total_stories completed ($remaining remaining)"

      if [[ $completed -gt 0 ]]; then
        local progress=$((completed * 100 / total_stories))
        echo -e "  Progress:   ${GREEN}${progress}%${NC}"
      fi

      # Show incomplete stories
      if [[ $remaining -gt 0 ]]; then
        echo ""
        echo "  Next stories:"
        jq -r '.userStories[] | select(.passes == false) | "    [\(.priority)] \(.id): \(.title)"' prd.json 2>/dev/null | head -5
      fi
    else
      echo "  PRD exists (install jq for details)"
    fi
  else
    warn "No prd.json found in this directory"
  fi

  echo ""

  # Check for Ralph monitor state
  if [[ -f ".ralph-monitor-state.json" ]]; then
    echo -e "${BLUE}━━━ Monitor Status ━━━${NC}"

    if command -v jq &>/dev/null; then
      local status=$(jq -r '.status // "unknown"' .ralph-monitor-state.json 2>/dev/null)
      local iteration=$(jq -r '.current_iteration // 0' .ralph-monitor-state.json 2>/dev/null)
      local current_story=$(jq -r '.current_story // "none"' .ralph-monitor-state.json 2>/dev/null)

      echo "  Status:         $status"
      echo "  Iteration:      $iteration"
      echo "  Current Story:  $current_story"

      if [[ -f ".ralph-monitor.pid" ]]; then
        local pid=$(cat .ralph-monitor.pid)
        if ps -p "$pid" &>/dev/null; then
          echo -e "  Monitor PID:    ${GREEN}$pid (running)${NC}"
        else
          echo -e "  Monitor PID:    ${YELLOW}$pid (stale)${NC}"
        fi
      fi
    else
      echo "  Monitor state exists (install jq for details)"
    fi
  else
    info "No active monitor session"
  fi

  echo ""

  # Check for timing data
  if [[ -f ".ralph-timing.json" ]]; then
    echo -e "${BLUE}━━━ Last Run Timing ━━━${NC}"

    if command -v jq &>/dev/null; then
      local duration=$(jq -r '.duration // "unknown"' .ralph-timing.json 2>/dev/null)
      local story_id=$(jq -r '.story_id // "unknown"' .ralph-timing.json 2>/dev/null)
      local ended_at=$(jq -r '.ended_at // "unknown"' .ralph-timing.json 2>/dev/null)

      echo "  Story:      $story_id"
      echo "  Duration:   ${duration}s"
      echo "  Ended:      $ended_at"
    else
      echo "  Timing data exists (install jq for details)"
    fi
  fi

  echo ""

  # Check for events log
  if [[ -f ".ralph-events.json" ]]; then
    echo -e "${BLUE}━━━ Recent Events ━━━${NC}"

    if command -v jq &>/dev/null; then
      echo "  Last 5 events:"
      jq -r '.events[-5:] | .[] | "    [\(.timestamp)] \(.type): \(.message)"' .ralph-events.json 2>/dev/null || echo "    No events"
    else
      echo "  Events exist (install jq for details)"
    fi
  fi

  echo ""
}

# Dispatch to subcommand
dispatch_command() {
  local cmd="$1"
  shift

  case "$cmd" in
    run)
      # Delegate to ralph.sh
      exec "$RALPH_SCRIPTS_DIR/ralph.sh" "$@"
      ;;
    quota)
      # Delegate to ralph-quota.sh
      exec "$RALPH_SCRIPTS_DIR/ralph-quota.sh" "$@"
      ;;
    hybrid)
      # Delegate to ralph-hybrid.sh
      exec "$RALPH_SCRIPTS_DIR/ralph-hybrid.sh" "$@"
      ;;
    stats)
      # Delegate to ralph-timing-db.sh
      exec "$RALPH_SCRIPTS_DIR/ralph-timing-db.sh" "$@"
      ;;
    status)
      # Implement unified status command (CLI-003)
      show_status "$@"
      exit 0
      ;;
    init)
      # TODO: Implement interactive init command (CLI-007)
      error "Init command not yet implemented (CLI-007)"
      ;;
    --help|-h|help)
      show_help
      exit 0
      ;;
    --version|-v|version)
      show_version
      exit 0
      ;;
    "")
      show_help
      exit 0
      ;;
    *)
      error "Unknown command: $cmd

Run 'ralph --help' for usage information."
      ;;
  esac
}

# Main entry point
main() {
  # Handle global flags first
  case "${1:-}" in
    --help|-h)
      show_help
      exit 0
      ;;
    --version|-v)
      show_version
      exit 0
      ;;
  esac

  # Dispatch to subcommand
  dispatch_command "$@"
}

main "$@"
