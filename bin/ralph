#!/bin/bash
# Ralph Ultra - Unified CLI
# Main entry point for all Ralph commands

set -e

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Output helpers
error() { echo -e "${RED}[ERROR]${NC} $1" >&2; exit 1; }
info() { echo -e "${BLUE}[INFO]${NC} $1"; }
success() { echo -e "${GREEN}[OK]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }

# Determine script directories
RALPH_BIN_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
RALPH_ROOT="$(dirname "$RALPH_BIN_DIR")"
RALPH_SCRIPTS_DIR="$RALPH_ROOT/scripts"
RALPH_VERSION_FILE="$RALPH_ROOT/VERSION"

# Ensure scripts directory exists
if [[ ! -d "$RALPH_SCRIPTS_DIR" ]]; then
  error "Scripts directory not found: $RALPH_SCRIPTS_DIR"
fi

# Read version
get_version() {
  if [[ -f "$RALPH_VERSION_FILE" ]]; then
    cat "$RALPH_VERSION_FILE" | tr -d '\n'
  else
    echo "unknown"
  fi
}

# Show version
show_version() {
  echo "ralph $(get_version)"
}

# Discover available commands from scripts directory
discover_commands() {
  local commands=()

  # Built-in commands (implemented in this file or as separate scripts)
  commands+=("run:Execute a Ralph project (wraps ralph.sh)")
  commands+=("status:Show Ralph status (quota, hybrid, timing)")
  commands+=("quota:Manage Claude Pro quota")
  commands+=("hybrid:Manage hybrid LLM routing")
  commands+=("stats:Show timing statistics")
  commands+=("init:Initialize a new Ralph project")

  printf '%s\n' "${commands[@]}"
}

# Show help
show_help() {
  cat << EOF
$(show_version)
Unified CLI for Ralph Ultra - Autonomous AI Agent System

USAGE:
  ralph <command> [options] [args]

COMMANDS:
  run       Execute a Ralph project (wraps ralph.sh)
  status    Show Ralph status (quota, hybrid, timing)
  quota     Manage Claude Pro quota
  hybrid    Manage hybrid LLM routing
  stats     Show timing statistics
  init      Initialize a new Ralph project

GLOBAL OPTIONS:
  --help, -h     Show this help
  --version, -v  Show version

Use 'ralph <command> --help' for command-specific help.

EXAMPLES:
  ralph run /path/to/project
  ralph status
  ralph quota --check
  ralph hybrid --status

For more information, visit: https://github.com/yourusername/ralph-ultra
EOF
}

# Show unified status
show_status() {
  local project_path="${1:-}"

  # Handle help flag
  if [[ "$project_path" == "--help" || "$project_path" == "-h" ]]; then
    cat << EOF
ralph status - Show Ralph system and project status

USAGE:
  ralph status                Show global status (quota, hybrid, timing)
  ralph status <project>      Show project-specific status

EXAMPLES:
  ralph status                # Global system status
  ralph status .              # Current project status
  ralph status /path/to/proj  # Specific project status

The global status shows:
  - Claude Pro quota usage and cooldowns
  - Hybrid LLM routing configuration and stats
  - Timing database statistics

The project status shows:
  - PRD progress (completed/remaining stories)
  - Monitor session status
  - Recent timing data
  - Event logs
EOF
    return 0
  fi

  # If project path provided, show project-specific status
  if [[ -n "$project_path" ]]; then
    show_project_status "$project_path"
    return
  fi

  # Otherwise show global status
  echo ""
  echo -e "${CYAN}╔══════════════════════════════════════════════════╗${NC}"
  echo -e "${CYAN}║              Ralph Ultra Status                  ║${NC}"
  echo -e "${CYAN}╚══════════════════════════════════════════════════╝${NC}"
  echo ""

  # 1. Quota Status
  echo -e "${BLUE}━━━ Quota Status ━━━${NC}"
  if [[ -f "$RALPH_SCRIPTS_DIR/ralph-quota.sh" ]]; then
    # Source the script to get functions
    (
      source "$RALPH_SCRIPTS_DIR/ralph-quota.sh"
      show_status 2>/dev/null || echo "  Quota check unavailable"
    )
  else
    warn "ralph-quota.sh not found"
  fi

  echo ""

  # 2. Hybrid LLM Status
  echo -e "${BLUE}━━━ Hybrid LLM Status ━━━${NC}"
  if [[ -f "$RALPH_SCRIPTS_DIR/ralph-hybrid.sh" ]]; then
    (
      source "$RALPH_SCRIPTS_DIR/ralph-hybrid.sh"
      show_status 2>/dev/null || echo "  Hybrid status unavailable"
    )
  else
    warn "ralph-hybrid.sh not found"
  fi

  echo ""

  # 3. Timing Database Status
  echo -e "${BLUE}━━━ Timing Database ━━━${NC}"
  if [[ -f "$RALPH_SCRIPTS_DIR/ralph-timing-db.sh" ]]; then
    (
      source "$RALPH_SCRIPTS_DIR/ralph-timing-db.sh"
      show_status 2>/dev/null || echo "  Timing stats unavailable"
    )
  else
    warn "ralph-timing-db.sh not found"
  fi

  echo ""
}

# Show project-specific status
show_project_status() {
  local project_path="$1"

  # Validate project directory
  if [[ ! -d "$project_path" ]]; then
    error "Project directory not found: $project_path"
  fi

  cd "$project_path" || error "Cannot access project directory: $project_path"

  echo ""
  echo -e "${CYAN}╔══════════════════════════════════════════════════╗${NC}"
  echo -e "${CYAN}║           Ralph Project Status                   ║${NC}"
  echo -e "${CYAN}╚══════════════════════════════════════════════════╝${NC}"
  echo ""

  info "Project: $(pwd)"
  echo ""

  # Check for PRD file
  if [[ -f "prd.json" ]]; then
    echo -e "${BLUE}━━━ PRD Status ━━━${NC}"

    if command -v jq &>/dev/null; then
      local project_name=$(jq -r '.project // "unknown"' prd.json 2>/dev/null)
      local branch_name=$(jq -r '.branchName // "unknown"' prd.json 2>/dev/null)
      local total_stories=$(jq '[.userStories[]] | length' prd.json 2>/dev/null)
      local completed=$(jq '[.userStories[] | select(.passes == true)] | length' prd.json 2>/dev/null)
      local remaining=$((total_stories - completed))

      echo "  Project:    $project_name"
      echo "  Branch:     $branch_name"
      echo "  Stories:    $completed/$total_stories completed ($remaining remaining)"

      if [[ $completed -gt 0 ]]; then
        local progress=$((completed * 100 / total_stories))
        echo -e "  Progress:   ${GREEN}${progress}%${NC}"
      fi

      # Show incomplete stories
      if [[ $remaining -gt 0 ]]; then
        echo ""
        echo "  Next stories:"
        jq -r '.userStories[] | select(.passes == false) | "    [\(.priority)] \(.id): \(.title)"' prd.json 2>/dev/null | head -5
      fi
    else
      echo "  PRD exists (install jq for details)"
    fi
  else
    warn "No prd.json found in this directory"
  fi

  echo ""

  # Check for Ralph monitor state
  if [[ -f ".ralph-monitor-state.json" ]]; then
    echo -e "${BLUE}━━━ Monitor Status ━━━${NC}"

    if command -v jq &>/dev/null; then
      local status=$(jq -r '.status // "unknown"' .ralph-monitor-state.json 2>/dev/null)
      local iteration=$(jq -r '.current_iteration // 0' .ralph-monitor-state.json 2>/dev/null)
      local current_story=$(jq -r '.current_story // "none"' .ralph-monitor-state.json 2>/dev/null)

      echo "  Status:         $status"
      echo "  Iteration:      $iteration"
      echo "  Current Story:  $current_story"

      if [[ -f ".ralph-monitor.pid" ]]; then
        local pid=$(cat .ralph-monitor.pid)
        if ps -p "$pid" &>/dev/null; then
          echo -e "  Monitor PID:    ${GREEN}$pid (running)${NC}"
        else
          echo -e "  Monitor PID:    ${YELLOW}$pid (stale)${NC}"
        fi
      fi
    else
      echo "  Monitor state exists (install jq for details)"
    fi
  else
    info "No active monitor session"
  fi

  echo ""

  # Check for timing data
  if [[ -f ".ralph-timing.json" ]]; then
    echo -e "${BLUE}━━━ Last Run Timing ━━━${NC}"

    if command -v jq &>/dev/null; then
      local duration=$(jq -r '.duration // "unknown"' .ralph-timing.json 2>/dev/null)
      local story_id=$(jq -r '.story_id // "unknown"' .ralph-timing.json 2>/dev/null)
      local ended_at=$(jq -r '.ended_at // "unknown"' .ralph-timing.json 2>/dev/null)

      echo "  Story:      $story_id"
      echo "  Duration:   ${duration}s"
      echo "  Ended:      $ended_at"
    else
      echo "  Timing data exists (install jq for details)"
    fi
  fi

  echo ""

  # Check for events log
  if [[ -f ".ralph-events.json" ]]; then
    echo -e "${BLUE}━━━ Recent Events ━━━${NC}"

    if command -v jq &>/dev/null; then
      echo "  Last 5 events:"
      jq -r '.events[-5:] | .[] | "    [\(.timestamp)] \(.type): \(.message)"' .ralph-events.json 2>/dev/null || echo "    No events"
    else
      echo "  Events exist (install jq for details)"
    fi
  fi

  echo ""
}

# Initialize a new Ralph project with interactive PRD generator
init_project() {
  local project_dir="${1:-.}"
  local use_template="${2:-}"

  # Handle help flag
  if [[ "$project_dir" == "--help" || "$project_dir" == "-h" ]]; then
    cat << EOF
ralph init - Initialize a new Ralph project

USAGE:
  ralph init [directory] [--template NAME]

OPTIONS:
  directory           Project directory (default: current directory)
  --template NAME     Use a template (webapp, cli, api, lib)

EXAMPLES:
  ralph init                      # Initialize in current directory
  ralph init ./my-project         # Initialize in my-project/
  ralph init . --template webapp  # Use webapp template

The interactive prompt will guide you through creating a prd.json file.
EOF
    return 0
  fi

  # Check for template flag
  if [[ "$project_dir" == "--template" ]]; then
    use_template="$2"
    project_dir="."
  elif [[ "$2" == "--template" ]]; then
    use_template="$3"
  fi

  # Ensure project directory exists
  if [[ ! -d "$project_dir" ]]; then
    read -p "$(echo -e "${YELLOW}Directory $project_dir does not exist. Create it? [y/N]:${NC} ")" -r create_dir
    if [[ ! "$create_dir" =~ ^[Yy]$ ]]; then
      error "Project directory does not exist: $project_dir"
    fi
    mkdir -p "$project_dir" || error "Failed to create directory: $project_dir"
    success "Created directory: $project_dir"
  fi

  cd "$project_dir" || error "Cannot access directory: $project_dir"

  # Check if prd.json already exists
  if [[ -f "prd.json" ]]; then
    read -p "$(echo -e "${YELLOW}prd.json already exists. Overwrite? [y/N]:${NC} ")" -r overwrite
    if [[ ! "$overwrite" =~ ^[Yy]$ ]]; then
      error "Aborting: prd.json already exists"
    fi
  fi

  echo ""
  echo -e "${CYAN}╔══════════════════════════════════════════════════╗${NC}"
  echo -e "${CYAN}║         Ralph Project Initialization             ║${NC}"
  echo -e "${CYAN}╚══════════════════════════════════════════════════╝${NC}"
  echo ""
  info "Creating a new Ralph project PRD"
  echo ""

  # Use template or interactive mode
  if [[ -n "$use_template" ]]; then
    create_from_template "$use_template"
  else
    create_interactive_prd
  fi
}

# Create PRD from template
create_from_template() {
  local template="$1"

  case "$template" in
    webapp)
      cat > prd.json << 'EOF'
{
  "project": "my-webapp",
  "description": "Web application with frontend and backend",
  "branchName": "feat/webapp",
  "techStack": ["typescript", "react", "node"],
  "userStories": [
    {
      "id": "WEB-001",
      "title": "Setup project structure",
      "description": "Initialize repository with basic structure and dependencies",
      "priority": 1,
      "complexity": "simple",
      "acceptanceCriteria": [
        "Package.json exists with all dependencies",
        "TypeScript configuration is set up",
        "Basic folder structure created"
      ],
      "passes": false
    }
  ]
}
EOF
      success "Created webapp template in prd.json"
      info "Edit prd.json to customize your project"
      ;;
    cli)
      cat > prd.json << 'EOF'
{
  "project": "my-cli",
  "description": "Command-line interface tool",
  "branchName": "feat/cli",
  "techStack": ["bash", "jq"],
  "userStories": [
    {
      "id": "CLI-001",
      "title": "Create main CLI entry point",
      "description": "Create executable script with command dispatch",
      "priority": 1,
      "complexity": "simple",
      "acceptanceCriteria": [
        "Main script exists and is executable",
        "Help text shows available commands",
        "Version command works"
      ],
      "passes": false
    }
  ]
}
EOF
      success "Created CLI template in prd.json"
      info "Edit prd.json to customize your project"
      ;;
    api)
      cat > prd.json << 'EOF'
{
  "project": "my-api",
  "description": "RESTful API service",
  "branchName": "feat/api",
  "techStack": ["typescript", "express", "postgresql"],
  "userStories": [
    {
      "id": "API-001",
      "title": "Setup API server",
      "description": "Initialize Express server with basic middleware",
      "priority": 1,
      "complexity": "simple",
      "acceptanceCriteria": [
        "Server starts on configured port",
        "Health check endpoint responds",
        "Error handling middleware works"
      ],
      "passes": false
    }
  ]
}
EOF
      success "Created API template in prd.json"
      info "Edit prd.json to customize your project"
      ;;
    lib)
      cat > prd.json << 'EOF'
{
  "project": "my-library",
  "description": "Reusable library package",
  "branchName": "feat/library",
  "techStack": ["typescript"],
  "userStories": [
    {
      "id": "LIB-001",
      "title": "Setup library structure",
      "description": "Initialize library with build and test setup",
      "priority": 1,
      "complexity": "simple",
      "acceptanceCriteria": [
        "TypeScript builds successfully",
        "Tests run successfully",
        "Package can be imported"
      ],
      "passes": false
    }
  ]
}
EOF
      success "Created library template in prd.json"
      info "Edit prd.json to customize your project"
      ;;
    *)
      error "Unknown template: $template

Available templates: webapp, cli, api, lib"
      ;;
  esac
}

# Create PRD interactively
create_interactive_prd() {
  local project_name description branch_name tech_stack
  local stories=()

  # Project basics
  read -p "$(echo -e "${BLUE}Project name:${NC} ")" -r project_name
  if [[ -z "$project_name" ]]; then
    project_name="my-project"
    info "Using default: $project_name"
  fi

  read -p "$(echo -e "${BLUE}Description:${NC} ")" -r description
  if [[ -z "$description" ]]; then
    description="A new Ralph project"
    info "Using default: $description"
  fi

  read -p "$(echo -e "${BLUE}Branch name:${NC} ")" -r branch_name
  if [[ -z "$branch_name" ]]; then
    branch_name="feat/${project_name}"
    info "Using default: $branch_name"
  fi

  read -p "$(echo -e "${BLUE}Tech stack (comma-separated, e.g., typescript,react,node):${NC} ")" -r tech_stack
  if [[ -z "$tech_stack" ]]; then
    tech_stack="bash"
    info "Using default: $tech_stack"
  fi

  echo ""
  info "Now let's add user stories (type 'done' when finished)"
  echo ""

  local story_count=0
  while true; do
    story_count=$((story_count + 1))

    echo -e "${CYAN}━━━ Story $story_count ━━━${NC}"

    read -p "$(echo -e "${BLUE}Story ID (e.g., US-001) or 'done':${NC} ")" -r story_id
    if [[ "$story_id" == "done" || -z "$story_id" ]]; then
      if [[ $story_count -eq 1 ]]; then
        warn "At least one story is recommended"
        read -p "$(echo -e "${YELLOW}Continue without stories? [y/N]:${NC} ")" -r continue_empty
        if [[ ! "$continue_empty" =~ ^[Yy]$ ]]; then
          continue
        fi
      fi
      break
    fi

    read -p "$(echo -e "${BLUE}Title:${NC} ")" -r story_title
    if [[ -z "$story_title" ]]; then
      warn "Story title is required"
      story_count=$((story_count - 1))
      continue
    fi

    read -p "$(echo -e "${BLUE}Description:${NC} ")" -r story_desc
    if [[ -z "$story_desc" ]]; then
      story_desc="$story_title"
    fi

    read -p "$(echo -e "${BLUE}Priority (1-10):${NC} ")" -r story_priority
    if [[ -z "$story_priority" ]]; then
      story_priority="$story_count"
    fi

    read -p "$(echo -e "${BLUE}Complexity (simple/medium/complex):${NC} ")" -r story_complexity
    if [[ -z "$story_complexity" ]]; then
      story_complexity="medium"
    fi

    # Acceptance criteria
    echo -e "${BLUE}Acceptance criteria (one per line, empty line to finish):${NC}"
    local criteria=()
    while true; do
      read -p "  - " -r criterion
      if [[ -z "$criterion" ]]; then
        break
      fi
      criteria+=("$criterion")
    done

    if [[ ${#criteria[@]} -eq 0 ]]; then
      criteria=("Story completed successfully")
    fi

    # Build story JSON
    local criteria_json=""
    for criterion in "${criteria[@]}"; do
      if [[ -n "$criteria_json" ]]; then
        criteria_json+=","
      fi
      criteria_json+="\"$criterion\""
    done

    local story_json=$(cat <<EOF
    {
      "id": "$story_id",
      "title": "$story_title",
      "description": "$story_desc",
      "priority": $story_priority,
      "complexity": "$story_complexity",
      "acceptanceCriteria": [$criteria_json],
      "passes": false
    }
EOF
)
    stories+=("$story_json")

    echo ""
  done

  # Build tech stack array
  IFS=',' read -ra tech_array <<< "$tech_stack"
  local tech_json=""
  for tech in "${tech_array[@]}"; do
    tech=$(echo "$tech" | xargs) # trim whitespace
    if [[ -n "$tech_json" ]]; then
      tech_json+=", "
    fi
    tech_json+="\"$tech\""
  done

  # Build stories array
  local stories_json=""
  for story in "${stories[@]}"; do
    if [[ -n "$stories_json" ]]; then
      stories_json+=","
    fi
    stories_json+="$story"
  done

  # Generate prd.json
  cat > prd.json << EOF
{
  "project": "$project_name",
  "description": "$description",
  "branchName": "$branch_name",
  "techStack": [$tech_json],
  "userStories": [
$stories_json
  ]
}
EOF

  echo ""
  success "Created prd.json with ${#stories[@]} user stories"

  # Validate JSON
  if command -v jq &>/dev/null; then
    if jq empty prd.json 2>/dev/null; then
      success "prd.json is valid JSON"
    else
      error "Generated prd.json is invalid. Please check the file manually."
    fi
  else
    info "Install jq to validate JSON automatically"
  fi

  echo ""
  info "Next steps:"
  echo "  1. Review prd.json and adjust as needed"
  echo "  2. Run: ralph run ."
  echo ""
}

# Dispatch to subcommand
dispatch_command() {
  local cmd="$1"
  shift

  case "$cmd" in
    run)
      # Delegate to ralph.sh
      exec "$RALPH_SCRIPTS_DIR/ralph.sh" "$@"
      ;;
    quota)
      # Delegate to ralph-quota.sh
      exec "$RALPH_SCRIPTS_DIR/ralph-quota.sh" "$@"
      ;;
    hybrid)
      # Delegate to ralph-hybrid.sh
      exec "$RALPH_SCRIPTS_DIR/ralph-hybrid.sh" "$@"
      ;;
    stats)
      # Delegate to ralph-timing-db.sh
      exec "$RALPH_SCRIPTS_DIR/ralph-timing-db.sh" "$@"
      ;;
    status)
      # Implement unified status command (CLI-003)
      show_status "$@"
      exit 0
      ;;
    init)
      # Interactive PRD generator (CLI-007)
      init_project "$@"
      exit 0
      ;;
    --help|-h|help)
      show_help
      exit 0
      ;;
    --version|-v|version)
      show_version
      exit 0
      ;;
    "")
      show_help
      exit 0
      ;;
    *)
      error "Unknown command: $cmd

Run 'ralph --help' for usage information."
      ;;
  esac
}

# Main entry point
main() {
  # Handle global flags first
  case "${1:-}" in
    --help|-h)
      show_help
      exit 0
      ;;
    --version|-v)
      show_version
      exit 0
      ;;
  esac

  # Dispatch to subcommand
  dispatch_command "$@"
}

main "$@"
